#+TITLE: IPv6 prefix delegation using systemd-networkd
#+AUTHOR: Sebastian Meisel
#+DATE: <2025-06-04 Mi>
:HTML_PROPERTIES:
#+OPTIONS: num:nil toc:nil
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="mystyle.css" />
:END:

#+ATTR_HTML: :width 100% :alt The Ostseepinguin banner showing a baltic penguin on the beach.
#+ATTR_LATEX: :width .65\linewidth
#+ATTR_ORG: :width 700
[[file:img/Ostseepinguin.png]]


#+NAME: toggle-mode-script
#+BEGIN_EXPORT HTML
<input type="checkbox" id="darkmode-toggle">
<label for="darkmode-toggle"></label></input>
<script src="script.js"></script>
#+END_EXPORT

#+begin_menu
[[file:NetworkNamespace.DE.html][ðŸ‡©ðŸ‡ª DE]]
- > [[file:index.html][Home]]

--------
#+ATTR_HTML: :width 16px :alt Mastodon
#+ATTR_LATEX: :width .65\linewidth
#+ATTR_ORG: :width 20
[[file:img/Mastodon.png]] https://emacs.ch/@SebasTEAan

ðŸ“§ [[mailto:sebastian.meisel+ostseepinguin@gmail.com][sebastian.meisel at gmail.com]]
#+end_menu

* Introduction

Recently my ~ISP~ (Internet Service Provider) finally provided me with modern ~IPv6~. I at least got an ~/60~ prefix, which allows me to do subnetting, with up to 16 subnets, as the network identifier in ~IPv6~ has ~64 bits~. So far so good. But I soon realized, that my prefix changes frequently, just as the ~IPv4~ prefix. That however is a problem. I do have two VLANs, beside my default network, that need their own ~GUA~ (Global Unicast Address) prefix. So whenever my prefix changes I would need to change my VLAN configurations and my routes. That's not feasible.


Gladly there is an solution to that problem: ~IPv6~ Prefix delegation (~PD~).

** How it works

With legacy ~DHCP~ you can automatically provide ~IPv4~ addresses and other configuration information to clients. With modern ~ICMPv6~ you can of cause do the same. But there is more: With ~PD~ you can provide whole network prefixes to a device.

That's actually how you get your ~IPv6~ prefix from your ~ISP~. Your Home router request a Prefix from the ~ISP's~ ~DHCPv6~ server. The ~ISP's DHCP~ server answers with a prefix of a certain length it delegates to your Home router. The good thing now is, that (given your Home router supports ~IA_PD~) you can use an internal router (e.Â g. a Linux machine) to request itself a portion of this prefix to again provide whole networks e.Â g.Â  for VLANs, as in my scenario.

#+ATTR_HTML: :width 80% :alt Left: Diagram illustrating IPv6 prefix delegation. The ISP assigns a /60 prefix (3fff:abcd:0:abcd::/60) to a home router. The home router then delegates two /64 prefixes from this /60 blockâ€”3fff:abcd:dcbd:abdc::/64 and 3fff:abcd:dcbd:abdd::/64â€”to two separate downstream devices after receiving individual requests.
#+ATTR_LATEX: :width .65\linewidth
#+ATTR_ORG: :width 700
[[file:img/IPv6PD.png]]

The individual Interface of the downstream router can now themself request a ~/64/~ network and an IPv6 address in that network.

** Set up

This is how my network currently looks:

#+ATTR_HTML: :width 80% :alt Left: The Internet (as a cloud) is connected to a home router via fiber. From there an Ethernet connection is drawn to a switch, which is connected to a Raspberry Pi, that acts as a router. Above the switch is connected to a Wireless AP, that provides Wifi to various mobile devices in the VLAN "WLAN", which is colored light orange. Beneath a desktop PC is connected to the switch, which is in the VLAN "Office", colored in light purple.
#+ATTR_LATEX: :width .65\linewidth
#+ATTR_ORG: :width 600
[[file:img/IPv6Network.png]]

My Home Router gets a ~/60~ IPv6 prefix which changes every few days. To that Home Router I connected a managed switch, so I can have VLANs. The firewall, DHCP(v6) server und router for these VLANs live on a Raspberry Pi, that functions as a router on a stick: It is connected to the switch on a trunk port and has 2 virtual devices for the two VLANsÂ â€” Office (VLAN Id 10) and WLAN (VLAN Id 20).

My Wifi access point is connect on an access port configured for VLAN 10 on my switch. The Office VLAN so far only contains my desktop Office PC.

** Configuring the Home router

First you have to find out if and where you can enable the DHCPv6 option ~IA_PD~ on your Home router. On my Home router (called Fritz!Box) the menu looks like this an is found under =Home Network â†’ Network â†’ Network Settings â†’ IPv6 Settings=.

ATTR_HTML: :width 80% :alt My Home router's Configuration with the option Â»Assign DNS server, prefix (IA_PD) and IPv6 address (IA_NA)Â« under Â»Enable DHCPv6 server in the Fritz!Box for home networkÂ« enabled. Fritz!Box is a brand for Home routers owned by AVM very popular in Germany.
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 600
[[file:img/IPv6PD_HomeRouter.png]]

** Configuring the WAN-interface

~/etc/systemd/network/10--eth0.network~
#+BEGIN_SRC text :tangle files/10-eth0.network
[Match]
Name=eth0
Type=ether

[Network]
Description=WAN Ethernet port

DHCP=ipv6
IPv6AcceptRA=yes

VLAN=Office
VLAN=WLAN

[Address]
Address=192.168.178.254
Gateway=192.168.178.1

[DHCPv6]
PrefixDelegationHint=::/60
UseDelegatedPrefix=yes
UseAddress=no


[Route]
Gateway=192.168.178.1
#+END_SRC


# Local Variables:
# jinx-languages: "en_US"
# End:
