<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-08-04 Mo 21:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IPv6PrefixDelegation for Virtual Machine Manager</title>
<meta name="author" content="Sebastian Meisel" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="mystyle.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">IPv6PrefixDelegation for Virtual Machine Manager</h1>


<div id="org11e677f" class="figure">
<p><img src="img/Ostseepinguin.png" alt="The Ostseepinguin banner showing a baltic penguin on the beach." width="100%" />
</p>
</div>


<input type="checkbox" id="darkmode-toggle">
<label for="darkmode-toggle"></label></input>
<script src="script.js"></script>

<div class="menu" id="orgb038e10">
<p>
<a href="IPv6Prefix_virtmanager_DE.html">🇩🇪 DE</a>
</p>
<ul class="org-ul">
<li>&gt; <a href="index.html">Home</a></li>
<li>&gt; <a href="IPv6PrefixDelegation.html">IPv6 prefix delegation (Part I)</a></li>
</ul>
<hr />
<p width="16px" alt="Mastodon">
<img src="img/Mastodon.png" alt="Mastodon" width="16px" /> <a href="https://linuxrocks.online/@SebasTEAan">https://linuxrocks.online/@SebasTEAan</a>
</p>

<p>
📧 <a href="mailto:sebastian.meisel+ostseepinguin@gmail.com">sebastian.meisel at gmail.com</a>
</p>

</div>
<div id="outline-container-orgc5f4a48" class="outline-2">
<h2 id="orgc5f4a48">Introduction</h2>
<div class="outline-text-2" id="text-orgc5f4a48">
<p>
After I set up <a href="IPv6PrefixDelegation.html">IPv6 Prefix Delegation (<code>PD</code>) on my Linux router</a>, I realized that I still need an <code>IPv6</code> subnet for the virtual machines (<code>VMs</code>) I run on my desktop PC.
</p>

<p>
For a <code>VM</code> to get an address from a delegated prefix, I need a bridged interface with a connected <code>VLAN</code>, and a way to propagate the prefix to that segment. In this guide, I use <code>systemd-networkd</code>. Alternatives like NetworkManager or netplan can be used similarly, but the focus here is on declarative <code>.network</code> and <code>.netdev</code> units.
</p>

<p>
I also want the <code>VLAN</code> to be configured on my physical switch, with addresses assigned on my router. My host computer works as a bridge in this scenario, not as a <code>NAT</code> gatway or router. This way the <code>VMs</code> do not have acces to my <code>Office VLAN</code> which gives me extra security. This is especially important to me, as one of the <code>VMs</code> is a Windows 11 machine, which I consider insecure.
</p>

<p>
In the end my network is supposed to look like this:
</p>


<div id="org670da87" class="figure">
<p><img src="img/IPv6Network_virtmanager.png" alt="IPv6Network_virtmanager.png" width="80% :alt: Left: The Internet (as a cloud) is connected to a home router via fiber. From there, an Ethernet connection is drawn to a switch, which is connected to a Raspberry Pi, that acts as a router. Above, the switch is connected to a Wireless AP, that provides WiFi to various mobile devices in the VLAN &quot;WLAN&quot;, which is colored light orange. Beneath, a desktop PC is connected to the switch, which is in the VLAN &quot;Office&quot;, colored in light purple. Inside this Office PC, a virtual machine (VM) is running, which is itself connected to the VLAN &quot;VLAN VM&quot;, depicted by a smaller blue network interface box within the Office PC." />
</p>
</div>
</div>
</div>
<div id="outline-container-org8585413" class="outline-2">
<h2 id="org8585413">Add new VLAN on the Switch</h2>
<div class="outline-text-2" id="text-org8585413">

<div id="orge847b57" class="figure">
<p><img src="img/Switch_VLAN30.png" alt="Switch_VLAN30.png" width="50%" />
</p>
</div>

<p>
ATTR<sub>HTML</sub>: :width 50%
</p>

<div id="org67d75b8" class="figure">
<p><img src="img/Switch_VLANPorts.png" alt="Switch_VLANPorts.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org19f6218" class="outline-2">
<h2 id="org19f6218">Add new VLAN on the Router</h2>
<div class="outline-text-2" id="text-org19f6218">
<div class="org-src-container">
<pre class="src src-text">[Match]
Name=eth0
Type=ether

[Network]
Description=Outbound Ethernet port

DHCP=ipv6
IPv6AcceptRA=yes

VLAN=Office
VLAN=WLAN
VLAN=VMs

[Address]
Address=192.168.178.254/24

[IPv6AcceptRA]
Token=::1

[DHCPv6]
PrefixDelegationHint=::/62
UseDelegatedPrefix=yes

[Route]
Gateway=192.168.178.1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">[NetDev]
Name=VMs
Kind=vlan

[VLAN]
Id=30
</pre>
</div>

<div class="org-src-container">
<pre class="src src-text">[Match]
Name=VMs
Type=vlan

[Network]
Description=VMs VLAN interface
DHCP=ipv6
IPv6SendRA=yes
IPv6AcceptRA=no
DHCPPrefixDelegation=yes

[Address]
Address=172.16.30.1/24

[DHCPPrefixDelegation]
Token=::1
SubnetId=0x2
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe845d5" class="outline-2">
<h2 id="orgbe845d5">Configure Host</h2>
<div class="outline-text-2" id="text-orgbe845d5">
</div>
<div id="outline-container-org2d5f354" class="outline-3">
<h3 id="org2d5f354">Configure networkd</h3>
<div class="outline-text-3" id="text-org2d5f354">
<p>
First, configure the physical Ethernet interface in <code>/etc/systemd/network/10-eth0.network</code>. I match the device by <code>MACAddress</code> rather than name, which avoids renaming issues after reboots or BIOS updates.
</p>

<p>
Explanation of key options:
</p>
<ul class="org-ul">
<li><code>DHCP=yes</code>: enables both IPv4 and IPv6 DHCP if advertised</li>
<li><code>IPv6AcceptRA=yes</code>: allows the interface to receive router advertisements</li>
<li><code>IPv6SendRA=yes</code>: enables the system to forward router advertisements to child interfaces</li>
<li><code>IPv4Forwarding=</code> and <code>IPv6Forwarding=</code>: enable packet forwarding</li>
<li><code>VLAN=</code>: binds named VLAN interfaces to this physical device</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">[Match]
MACAddress=d8:bb:c1:8b:b9:d1
Type=ether

[Network]
Description=Physical Ethernet Port
DHCP=yes
IPv6AcceptRA=yes
IPv6SendRA=yes
</pre>
</div>

<p>
Just to be sure, I also activate forwarding:
</p>

<div class="org-src-container">
<pre class="src src-text">IPv4Forwarding=yes
IPv6Forwarding=yes
</pre>
</div>


<p>
Here is also the place to include the <code>VLANs</code> which are connected to that device — in this case:
</p>

<ol class="org-ol">
<li><code>Office</code> for the host and</li>
<li><code>VM</code> for the virtual machines.</li>
</ol>

<div class="org-src-container">
<pre class="src src-text">VLAN=Office
VLAN=VM
</pre>
</div>
</div>
</div>
<div id="outline-container-org25e8362" class="outline-3">
<h3 id="org25e8362">VLAN 10: Host network</h3>
<div class="outline-text-3" id="text-org25e8362">
<p>
I want to use the Office <code>VLAN</code> for my host, as it is my Office PC in <code>/etc/systemd/network/00-vlan10.netdev</code>. To use it I need to first define a virtual network of <code>Kind</code> <code>vlan</code>. In the <code>[VLAN]</code> I need to give the <code>VLAN Id</code>.
</p>

<div class="org-src-container">
<pre class="src src-conf" id="org8d89119">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">NetDev</span>]
<span style="font-style: italic;">Name</span>=Office
<span style="font-style: italic;">Kind</span>=vlan

[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">VLAN</span>]
<span style="font-style: italic;">Id</span>=10
</pre>
</div>

<p>
Next I have to configure it in <code>/etc/systemd/network/20-vlan10.network</code> For addressing I use <code>DHCP</code> and <code>RA</code> for <code>IPv6</code> again.
</p>


<div class="org-src-container">
<pre class="src src-conf" id="org36344f8">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Match</span>]
<span style="font-style: italic;">Name</span>=Office
<span style="font-style: italic;">Type</span>=vlan

[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Network</span>]
<span style="font-style: italic;">Description</span>=Office VLAN interface
<span style="font-style: italic;">DHCP</span>=yes
<span style="font-style: italic;">IPv6AcceptRA</span>=yes
</pre>
</div>

<p>
This will be the device I actually connect to on my host.
</p>
</div>
</div>
</div>
<div id="outline-container-org66e4ae0" class="outline-2">
<h2 id="org66e4ae0">VLAN 30: Bridge for VMs</h2>
<div class="outline-text-2" id="text-org66e4ae0">
<p>
Next I need a <code>VLAN</code> interface for the virtual machines:
</p>
</div>
<div id="outline-container-org850eed2" class="outline-3">
<h3 id="org850eed2">VLAN 30: Bridge for VMs</h3>
<div class="outline-text-3" id="text-org850eed2">
<p>
NAME: 50-vlan20.netdev
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">NetDev</span>]
<span style="font-style: italic;">Name</span>=VM
<span style="font-style: italic;">Kind</span>=vlan

[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">VLAN</span>]
<span style="font-style: italic;">Id</span>=30

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbc67d4a" class="outline-2">
<h2 id="orgbc67d4a">Bridge device (br30)</h2>
<div class="outline-text-2" id="text-orgbc67d4a">
<p>
And I need a brigde device to which the <code>VMs</code> can connect.
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">NetDev</span>]
<span style="font-style: italic;">Name</span>=br30
<span style="font-style: italic;">Kind</span>=bridge
</pre>
</div>
</div>
</div>
<div id="outline-container-org1b8465b" class="outline-2">
<h2 id="org1b8465b">Attach VLAN 30 to the bridge</h2>
<div class="outline-text-2" id="text-org1b8465b">
<p>
Now I need to connect the bridge device to the virtual <code>VLAN</code> interface, I called <code>VM</code>. For that I use the following options in <code>/etc/systemd/network/20-vlan3.network</code>.:
</p>

<ul class="org-ul">
<li><code>Bridge=br30</code> connects this VLAN interface to the bridge</li>
<li><code>IPv6AcceptRA=yes</code> allows RA to be accepted and relayed to VMs</li>
<li><code>LinkLocalAddressing=ipv6</code> ensures IPv6 link-local addresses are generated</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Match</span>]
<span style="font-style: italic;">Name</span>=VM
<span style="font-style: italic;">Type</span>=vlan

[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Network</span>]
<span style="font-style: italic;">Description</span>=VM VLAN interface
<span style="font-style: italic;">Bridge</span>=br30
<span style="font-style: italic;">IPv6AcceptRA</span>=yes
<span style="font-style: italic;">LinkLocalAddressing</span>=ipv6
</pre>
</div>
</div>
<div id="outline-container-org4d08f33" class="outline-3">
<h3 id="org4d08f33">Bridge interface configuration</h3>
<div class="outline-text-3" id="text-org4d08f33">
<p>
The bridge itself should be transparent, not routing or managing <code>RA</code>:
</p>

<p>
Explanation:
</p>
<ul class="org-ul">
<li><code>IPv6AcceptRA=no</code> avoids the bridge configuring itself.</li>
<li><code>IPv6SendRA=no</code> prevents the bridge from issuing router advertisements.</li>
<li><code>LinkLocalAddressing=kernel</code> lets the kernel assign a link-local address.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf" id="orgdf6127e">[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Match</span>]
<span style="font-style: italic;">Name</span>=br30

[<span style="color: #a2a0b2; font-weight: bold; font-style: italic;">Network</span>]
<span style="font-style: italic;">BridgeForwardDelaySec</span>=0
<span style="font-style: italic;">IPv6AcceptRA</span>=no
<span style="font-style: italic;">IPv6SendRA</span>=no
<span style="font-style: italic;">LinkLocalAddressing</span>=kernel

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0ed3d49" class="outline-2">
<h2 id="org0ed3d49">Virtual Machine Configuration</h2>
<div class="outline-text-2" id="text-org0ed3d49">
<p>
Connect your VM interfaces to <code>br30</code> using `virt-manager` or XML: 
</p>

<div class="org-src-container">
<pre class="src src-xml"><span style="color: #ffffff; background-color: #000000;">&lt;</span><span style="color: #cfcff8;">interface</span> <span style="font-style: italic;">type</span>=<span style="color: #a2a0b2;">'bridge'</span><span style="color: #ffffff; background-color: #000000;">&gt;</span>
  <span style="color: #ffffff; background-color: #000000;">&lt;</span><span style="color: #cfcff8;">source</span> <span style="font-style: italic;">bridge</span>=<span style="color: #a2a0b2;">'br30'</span><span style="color: #ffffff; background-color: #000000;">/</span><span style="color: #ffffff; background-color: #000000;">&gt;</span>
  <span style="color: #ffffff; background-color: #000000;">&lt;</span><span style="color: #cfcff8;">model</span> <span style="font-style: italic;">type</span>=<span style="color: #a2a0b2;">'virtio'</span><span style="color: #ffffff; background-color: #000000;">/</span><span style="color: #ffffff; background-color: #000000;">&gt;</span>
<span style="color: #ffffff; background-color: #000000;">&lt;</span><span style="color: #ffffff; background-color: #000000;">/</span><span style="color: #cfcff8;">interface</span><span style="color: #ffffff; background-color: #000000;">&gt;</span>
</pre>
</div>


<div id="org21fd244" class="figure">
<p><img src="img/VirtManagerBridge.png" alt="Screenshot of the network interface settings of a virtual machine, from the Virt-Manager GUI. On the left, a vertical navigation menu lists various configuration sections including “Overview,” “OS information,” “CPUs,” “Memory,” “NIC :e7:4c:6a” (currently selected),  and others. On the right, the details tab is open for the virtual network interface: Tab: “Details” (active, next to “XML”); Network source: “Bridge device...”; Device name: br20; Device model: virtio (dropdown shown); MAC address: 52:54:00:e7:4c:6a; IP address: “Unknown”; Link state: active (checkbox checked)." width="50%" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgadedcc6" class="outline-2">
<h2 id="orgadedcc6">Configure VLAN 30 on the router</h2>
<div class="outline-text-2" id="text-orgadedcc6">
<p>
On my raspberry pi router I now need to configure the new <code>VLAN 30</code> for the <code>VMs</code>. First I need to configure <code>/etc/systemd/network/00-vlan30.netdev</code> there:
</p>

<div class="org-src-container">
<pre class="src src-text">[NetDev]
Name=VMs
Kind=vlan

[VLAN]
Id=30
</pre>
</div>
</div>
<div id="outline-container-org60a8b31" class="outline-3">
<h3 id="org60a8b31">Bridge device (br20)</h3>
<div class="outline-text-3" id="text-org60a8b31">
<p>
Next comes <code>/etc/systemd/network/20-vlan30.network</code>:
</p>
<div class="org-src-container">
<pre class="src src-text">[Match]
Name=VMs
Type=vlan

</pre>
</div>
</div>
</div>
<div id="outline-container-orga818574" class="outline-3">
<h3 id="orga818574">Attach VLAN 20 to the bridge</h3>
<div class="outline-text-3" id="text-orga818574">
<p>
In the <code>[Network]</code> section we need the following options:
</p>
<dl class="org-dl">
<dt>DHCP=ipv6</dt><dd>Enables the DHCPv6 client on this interface.</dd>
<dt>IPv6SendRA=yes</dt><dd>The system sends Router Advertisements (<code>RA</code>) on this interface.</dd>
<dt>IPv6AcceptRA=yes</dt><dd>The system accepts incoming Router Advertisements.</dd>
<dt>DHCPPrefixDelegation=yes</dt><dd>Enables the interface to request a delegated prefix via <code>DHCPv6</code>.</dd>
</dl>


<div class="org-src-container">
<pre class="src src-text">[Network]
Description=VMs VLAN interface
DHCP=ipv6
IPv6SendRA=yes
IPv6AcceptRA=yes
DHCPPrefixDelegation=yes

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd839bd7" class="outline-3">
<h3 id="orgd839bd7">Bridge interface configuration</h3>
<div class="outline-text-3" id="text-orgd839bd7">
<dl class="org-dl">
<dt>Token=::1</dt><dd>Specifies the interface identifier (<code>IID</code>) suffix to be used when constructing the delegated address or prefix. This value is appended to the delegated prefix to form the full IPv6 address. For example, with a delegated prefix <code>2001:db8:1234:567c:/62</code> and <code>Token=::1</code>, the resulting address might be <code>2001:db8:1234:567c::1</code>.</dd>
<dt>SubnetId=0x2</dt><dd>Specifies a hexadecimal subnet ID used to select a specific <code>/64</code> subnet from the delegated prefix. For example, with a delegated <code>/62</code>, setting <code>SubnetId=0x2</code> would assign the third network <code>2001:db8:1234:567e::/64</code> to the interface.</dd>
<dt>Assign=yes</dt><dd>Indicates that the selected subnet (via <code>SubnetId</code>) should be assigned to the interface automatically.</dd>
<dt>Announce=yes</dt><dd>Enables the system to announce the assigned prefix via <code>RA</code>, making it available to other devices on the link.</dd>
</dl>


<div class="org-src-container">
<pre class="src src-text">[DHCPPrefixDelegation]
Token=::1
SubnetId=0x2
Assign=yes
Announce=yes

</pre>
</div>

<p>
Lastly I need to setup my legacy <code>DHCP</code> pool for the <code>VMs VLAN</code> in <code>/etc/dnsmasq.d/00-vlans.conf</code>:
</p>

<dl class="org-dl">
<dt>interface=VMs</dt><dd>Binds `dnsmasq` to the network interface named `VMs`. It will listen and provide DHCP on this interface.</dd>

<dt>dhcp-range=set:vlan30,172.16.30.10,172.16.30.200,255.255.255.0,24h</dt><dd>Defines a DHCP address pool for clients tagged with `vlan30`. The range is from `172.16.30.10` to `172.16.30.200`, with a subnet mask of `255.255.255.0`, and lease duration of 24 hours.</dd>

<dt>dhcp-option=tag:vlan30,option:router,192.168.178.254</dt><dd>Specifies the default gateway (router) for DHCP clients tagged with `vlan30`. Clients will receive `192.168.178.254` as their default route, which is my pi-routers <code>WAN interface IP</code>.</dd>

<dt>dhcp-option=tag:vlan30,option:dns-server,192.168.178.254</dt><dd>Sets the DNS server for clients tagged with `vlan30` to `192.168.178.254`. This is sent as part of the DHCP offer.</dd>
</dl>


<div class="org-src-container">
<pre class="src src-text"># DHCP for vlan-interfaces
interface=WLAN
dhcp-range=set:vlan10,172.16.10.10,172.16.10.200,255.255.255.0,24h
dhcp-option=tag:vlan10,option:router,192.168.178.254
dhcp-option=tag:vlan10,option:dns-server,192.168.178.254

interface=Office
dhcp-range=set:vlan20,172.16.20.10,172.16.20.200,255.255.255.0,24h
dhcp-option=tag:vlan20,option:router,192.168.178.254
dhcp-option=tag:vlan20,option:dns-server,192.168.178.254

interface=VMs
dhcp-range=set:vlan30,172.16.30.10,172.16.30.200,255.255.255.0,24h
dhcp-option=tag:vlan30,option:router,192.168.178.254
dhcp-option=tag:vlan30,option:dns-server,192.168.178.254

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga2fbb5a" class="outline-2">
<h2 id="orga2fbb5a">Configure VLAN 30 on the Switch</h2>
<div class="outline-text-2" id="text-orga2fbb5a">
<p>
For the whole setup to work I also need to create the <code>VLAN</code> with <code>Id 30</code> on the managed switch. How to do this depends on your type of switch of course.
</p>


<div id="org7c7d542" class="figure">
<p><img src="img/VLAN30_Switch.png" alt="Screenshot of the VLAN configuration page on a Netgear S350 Smart Managed Pro Switch (example). The interface lists VLANs with their IDs, names, and types. VLAN 30 named &quot;VMs&quot; is selected and set as Statisch (Static). Other VLANs include ID 1 (default), 2 (Auto-VoIP), 10 (Office), 20 (WLAN), and 4089 (Auto-Video). The user is in the “Switching” &gt; “VLAN” &gt; “VLAN-Konfiguration” section." width="50%" />
</p>
</div>

<p>
You need to make sure, that the interface connect to the host PC is marked as ’tagged’ and that the <code>VLAN 10</code> and <code>30</code> are associated with the port. You also need to associate <code>VLAN 30</code> with the port to the router.
</p>


<div id="org59f8e35" class="figure">
<p><img src="img/PortKonfigurationSwitch.png" alt="Screenshot of the “Port-PVID-Konfiguration” page on a Netgear S350 switch. The table shows port-based VLAN configuration. Ports where VLAN 30 is configured: g1: PVID: 10, VLAN Member: 1,10,30, VLAN Tag: 10,30; g6: PVID: 1, VLAN Member: 1,10,30, VLAN Tag: 10,30. Other ports (g2 to g5) are not members of VLAN 30. The active section in the sidebar is Port-PVID-Konfiguration under “Erweitert” (German for Advanced)." width="50%" />
</p>
</div>
</div>
</div>
<div id="outline-container-orga40df38" class="outline-2">
<h2 id="orga40df38">Switch to systemd-networkd</h2>
<div class="outline-text-2" id="text-orga40df38">
<p>
My system ran on <code>NetworkManager</code>, which I want to replace by <code>systemd-networkd</code> now, which is the better choice on a desktop without <code>Wifi</code> anyway. This is easly done by running:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo systemctl disable --now NetworkManager
sydo systemctl enable --now systemd-networkd
</pre>
</div>

<p>
Just checking that there occurred no problems:
</p>

<div class="org-src-container">
<pre class="src src-bash" id="org393088f">systemctl status systemd-networkd
</pre>
</div>


<p>
The output should look something like this:
</p>
<pre class="example" id="org06c7407">
● systemd-networkd.service - Network Configuration
     Loaded: loaded (/usr/lib/systemd/system/systemd-networkd.service; enabled; preset: disabled)
     Active: active (running) since Thu 2025-07-31 07:45:37 CEST; 2 days ago
 Invocation: 8fc13f7bd3854763a86c1eb8900269a7
TriggeredBy: ● systemd-networkd.socket
       Docs: man:systemd-networkd.service(8)
             man:org.freedesktop.network1(5)
   Main PID: 1521 (systemd-network)
     Status: "Processing requests..."
      Tasks: 1 (limit: 19023)
   FD Store: 0 (limit: 512)
        CPU: 3.775s
     CGroup: /system.slice/systemd-networkd.service
             └─1521 /usr/lib/systemd/systemd-networkd

Warning: some journal files were not opened due to insufficient permissions.
</pre>

<p>
And I also check that all device are up and configured:
</p>

<div class="org-src-container">
<pre class="src src-bash" id="orgb0685ba">ip --brief a 
</pre>
</div>

<p>
Only the <code>Office</code> interface should get an Global Unicast IPv6 Address (<code>GUA</code>).
</p>

<pre class="example" id="org3397c67">
lo               UNKNOWN        127.0.0.1/8 ::1/128 
enp0s16f0u1      UP             172.16.10.154/24 metric 1024 fe80::dabb:c1ff:fe8b:b9d1/64 
br30             UP             fe80::84d9:45ff:fe20:bb32/64 
Office@enp0s16f0u1 UP             172.16.10.155/24 metric 1024 3fff:abc:def:bf0c:dabb:c1ff:fe8b:b9d1/64 fe80::dabb:c1ff:fe8b:b9d1/64 
VM@enp0s16f0u1   UP             fe80::dabb:c1ff:fe8b:b9d1/64 
</pre>
</div>
</div>
<div id="outline-container-orgf4d8ac6" class="outline-2">
<h2 id="orgf4d8ac6">Disable filtering for the bridge device</h2>
<div class="outline-text-2" id="text-orgf4d8ac6">
<p>
Up to this point everything work very straight forward. But when I tried to connect to the network, I didn't get an address. It took me quite some time to find the problem and solve it.
</p>

<p>
The problem is the default behavior on Linux is, that some packages are filtered on Layer 3 as well as Layer 2. As we are using the host as a mere bridge to the Virtual Machines, that' not desired. So we need to deactivate this behavior for bridge devices:
</p>

<p>
<code>/etc/sysctl.d/99-brigde.conf</code>
</p>
<div class="org-src-container">
<pre class="src src-text">net.bridge.bridge-nf-call-ip6tables=0
net.bridge.bridge-nf-call-iptables=0
net.bridge.bridge-nf-call-arptables=0
</pre>
</div>

<p>
This would however only take affect after a system restart, unless you read the file with <code>sysctl</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo sysctl -f /etc/sysctl.d/99-bridge.conf
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb9f4744" class="outline-2">
<h2 id="orgb9f4744">Conclusion</h2>
<div class="outline-text-2" id="text-orgb9f4744">
<p>
When you know the options to set, it is very easy to set up a dedicated VLAN from you router straight to you <code>VMs</code>. There are of course two more things to consider:
</p>

<ul class="org-ul">
<li>You can not easily bridge <code>Wifi</code> interfaces.</li>
<li>Your <code>VMs</code> are on a separate subnet, so you can not just <code>ssh</code> into them. There are serveral possible solutions to this:
<ul class="org-ul">
<li>Dedicated forwarding roules using nftables.</li>
<li>Use <a href="https://tailscale.com/">tailscale</a> or <a href="https://github.com/slackhq/nebula">nebula</a>.</li>
<li>My preferred method is however a proxy jump over my pi-router. In <code>${HOME}/.ssh/config</code> it looks like that:</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-text">Host Win Windows Window11 Windoof win
     HostName          fe80::d8b8:3a7:126b:162b%%VMs
     User             Username
     IdentityFile       ~/.ssh/win
     ProxyJump         pi
Host *
    IdentitiesOnly      yes

</pre>
</div>

<dl class="org-dl">
<dt>Host Win Windows Window11 Windoof win</dt><dd>Defines a group of host aliases. You can use any of these names (`Win`, `Windows`, etc.) with `ssh`, and the settings below will apply.
<dl class="org-dl">
<dt>HostName fe80::d8b8:3a7:126b:162b%%VMs</dt><dd>Specifies the actual destination host. In this case, it's a link-local IPv6 address with the zone index `%%VMs` (the interface name needed for link-local communication).</dd>
<dt>User Username</dt><dd>Sets the SSH username to `Username` for this host.</dd>
<dt>IdentityFile ~/.ssh/win</dt><dd>Specifies the private SSH key file to use when connecting to this host.</dd>
<dt>ProxyJump pi</dt><dd>Uses the host alias `pi` as a jump host (SSH proxy). SSH will first connect to `pi`, then use it to reach the Windows machine.</dd>
</dl></dd>
<dt>Host *</dt><dd>A wildcard match for all hosts not explicitly listed above.
<dl class="org-dl">
<dt>IdentitiesOnly yes</dt><dd>Ensures that only the identity files explicitly specified in the config (e.g. `~/.ssh/win`) are used for authentication, preventing SSH from trying other keys loaded in the agent.</dd>
</dl></dd>
</dl>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2025-06-18 Mi 00:00</p>
<p class="author">Author: Sebastian Meisel</p>
<p class="date">Created: 2025-08-04 Mo 21:51</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
